{% extends "base.html" %}
{% load url from future %}
{% load static from staticfiles %}
{% block extra_head_js %}
    <script type="text/javascript" src="{% static 'js/bootstrap-typeahead.js'%}"></script>
    <script type="text/javascript" src="{% static 'js/modernizr.custom.js'%}"></script>
    <script>
        if ( !Modernizr.xhr2 ) {
          window.location.href = "${request.route_url('old_browser')}";
        }
        $(function(){
          var sourcerer = function (field) {
            return function (query, process) {
              $.getJSON(
                "/api/v1/Archive/values/",
                {field: field, q: query},
                  function (response) {
                      return process(response.values)
                  }
              );
            };
          };
          $("#id_name").typeahead({source: sourcerer("submitter_name")});
          $("#id_site_name").typeahead({source: sourcerer("site")});

          function on_upload_progress(event) {
            var progress = Math.round(event.loaded / event.total * 100)+'%';
            $("#progress_bar").css('width', progress);
            $("#progress_percent").html(progress);
          }

          $('#new_archive').submit(function(event) {
            event.preventDefault();
            $("#file_select").hide();
            $("#file_progress").show();
            var formData = new FormData($('#new_archive')[0]);
            dumb = $.ajax({
              url: '/upload',  //server script to process data
              type: 'POST',
              xhr: function() {  // custom xhr
                var myXhr = $.ajaxSettings.xhr();
                if(myXhr.upload){ // check if upload property exists
                  myXhr.upload.addEventListener('progress', on_upload_progress, false); // for handling the progress of the upload
                }
                return myXhr;
              },
              // Form data
              data: formData,
              dataType: 'json',
              //Options to tell JQuery not to process data or worry about content-type
              cache: false,
              contentType: false,
              processData: false
            }).done(function(data){
              $("#progress_bar").css('width', "100%");
              $("#progress_percent").html("100%");
              if (data.valid) {
                window.location.href = data.url;
              } else {
                $("#file_select").show();
                $("#file_progress").hide();
                $("#log").prepend('<p class="alert alert-error">Invalid upload.<p>');
                $("#log_container").slideDown();
              }
            }).fail(function(xhr, status){
              console.log("Request failed: " + status);
              $("#log").prepend('<p class="alert alert-error">Upload error ' + status + '. Refresh the page and retry.<p>');
              $("#action_container").slideUp();
              $("#log_container").slideDown();
            });
          });
        });
    </script>
    <style type="text/css">
    #progress_bar {
      -webkit-transition: none;
         -moz-transition: none;
           -o-transition: none;
              transition: none;
    }
  </style>
{% endblock extra_head_js %}
{% block content %}
    <h1>Upload <small> a new archive for testing</small></h1>
    <div class="row">
        <div class="span6">
            <!-- Upload form. Note enctype attribute! -->
            <form action="{% url "upload" %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <p>{{ form.non_field_errors }}</p>
                <div class="row">
                    <div class="span3">
                        <p>{{ form.name.label_tag }}</p>
                        {{ form.name }}
                    </div>
                    <div class="span3">
                        <p>{{ form.site_name.label_tag }}</p>
                        {{ form.site_name }}
                    </div>
                </div>
                <div class="row">
                    <div class="span3">
                      <p>{{ form.archive_identifier.label_tag }}</p>
                      {{ form.archive_identifier }}
                    </div>
                    <div class="span3">
                        <p>{{ form.archive_type.label_tag }}</p>
                        <select name="archive_type" id="archiveType">
                            {% for device in form.archive_type.field.choices %}
                                <option>{{ device }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="span3">
                        <p>{{ form.taser_ticket_number.label_tag }}</p>
                        {{ form.taser_ticket_number }}
                    </div>
                </div>
                <div style="height: 60px;">
                    <div id="file_select">
                        <p>{{ form.doc_file.label_tag }} {{ form.doc_file.help_text }}</p>
                        <p>
                            {{ form.doc_file.errors }}
                            {{ form.doc_file }}
                        </p>
                    </div>
                </div>
                <div id="action_container">
                    <div class="form-actions">
                        <input type="submit" value="Submit Archive" class="btn btn-primary">
                        <button class="btn" type="reset">Reset</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="span6">
            <dl>
                <dt>Your Name</dt>
                <dd></dd>
                <dt>Site Name</dt>
                <dd>Must remain consistent for search functionality. ex) geneticDX and genetic DX will not be grouped the same.</dd>
                <dt>Archive Label</dt>
                <dd>Description of the run ex) Low Loading, High LQ, CEPH Control, Good Run</dd>
                <dt>Archive Type</dt>
                <dd>Each has specific tests according to the CSA/log type.</dd>
                <dt>TASER Ticket Number</dt>
                <dd>Links runs upload to a TASER ticket.  This can be edited if ticket is created at a later time.</dd>
                <dt>Select File</dt>
                <dd>Choose zipped CSA or log</dd>
                <dt>Submit!</dt>
                <dd></dd>
            </dl>
        </div>
    </div>
{% endblock content %}