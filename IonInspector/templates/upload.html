{% extends "base.html" %}
{% load url from future %}
{% load static from staticfiles %}
{% block extra_head_js %}
    <script type="text/javascript" src="{% static 'js/bootstrap-typeahead.js'%}"></script>
    <script type="text/javascript" src="{% static 'js/modernizr.custom.js'%}"></script>
    <script>
        if ( !Modernizr.xhr2 ) {
          window.location.href = "${request.route_url('old_browser')}";
        }
        $(function(){
          var sourcerer = function (what) {
            return function (query, process) {
              $.getJSON(
                "/api/auto_complete",
                {what: what, match: query},
                process
              );
            };
          };
          $("#name").typeahead({source: sourcerer("name")});
          $("#site").typeahead({source: sourcerer("site")});

          function on_upload_progress(event) {
            var progress = Math.round(event.loaded / event.total * 100)+'%';
            $("#progress_bar").css('width', progress);
            $("#progress_percent").html(progress);
          }

          $('#new_archive').submit(function(event) {
            event.preventDefault();
            $("#file_select").hide();
            $("#file_progress").show();
            var formData = new FormData($('#new_archive')[0]);
            dumb = $.ajax({
              url: '/upload',  //server script to process data
              type: 'POST',
              xhr: function() {  // custom xhr
                var myXhr = $.ajaxSettings.xhr();
                if(myXhr.upload){ // check if upload property exists
                  myXhr.upload.addEventListener('progress', on_upload_progress, false); // for handling the progress of the upload
                }
                return myXhr;
              },
              // Form data
              data: formData,
              dataType: 'json',
              //Options to tell JQuery not to process data or worry about content-type
              cache: false,
              contentType: false,
              processData: false
            }).done(function(data){
              $("#progress_bar").css('width', "100%");
              $("#progress_percent").html("100%");
              if (data.valid) {
                window.location.href = data.url;
              } else {
                $("#file_select").show();
                $("#file_progress").hide();
                $("#log").prepend('<p class="alert alert-error">Invalid upload.<p>');
                $("#log_container").slideDown();
              }
            }).fail(function(xhr, status){
              console.log("Request failed: " + status);
              $("#log").prepend('<p class="alert alert-error">Upload error ' + status + '. Refresh the page and retry.<p>');
              $("#action_container").slideUp();
              $("#log_container").slideDown();
            });
          });
        });
    </script>
    <style type="text/css">
    #progress_bar {
      -webkit-transition: none;
         -moz-transition: none;
           -o-transition: none;
              transition: none;
    }
  </style>
{% endblock extra_head_js %}
{% block content %}
    <h1>Upload <small> a new archive for testing</small></h1>
    <div class="row">
        <div class="span6">
            <!-- Upload form. Note enctype attribute! -->
            <form action="{% url "upload" %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <p>{{ form.non_field_errors }}</p>
                <div class="row">
                    <div class="span3">
                        <p>{{ form.name.label_tag }}</p>
                        {{ form.name }}
                    </div>
                    <div class="span3">
                        <p>{{ form.site_name.label_tag }}</p>
                        {{ form.site_name }}
                    </div>
                </div>
                <div class="row">
                    <div class="span3">
                      <p>{{ form.archive_label.label_tag }}</p>
                      {{ form.archive_label }}
                    </div>
                    <div class="span3">
                        <p>{{ form.archive_type.label_tag }}</p>
                        <select name="archive_type" id="archiveType">
                            {% for device in form.archive_type.field.choices %}
                                <option>{{ device }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="height: 60px;">
                    <div id="file_select">
                        <p>{{ form.doc_file.label_tag }} {{ form.doc_file.help_text }}</p>
                        <p>
                            {{ form.doc_file.errors }}
                            {{ form.doc_file }}
                        </p>
                    </div>
                </div>

                <p><input type="submit" value="Upload" /></p>
            </form>
        </div>
        <div class="span6">
            <dl>
              <dt>Your name</dt>
              <dd>Use the name by which people can easily identify your uploads.</dd>
              <dt>Site name</dt>
              <dd>Use the name by which people can easily identify the site from which the upload originates, a consistent name that does not change between uploads which are from the same site.</dd>
              <dt>Archive Label</dt>
              <dd>Use label to label individual uploads something meaningful. For example, if you're fond of appending incrementing numbers to your uploads, do that in this field.  This will be auto-generated if left empty.</dd>
            </dl>
        </div>
    </div>
{% endblock content %}