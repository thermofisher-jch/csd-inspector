{% extends "base.html" %}
{% load staticfiles %}
{% block content %}
    <div id="delete_prompt" class="row-fluid" style="display: none;">
        <div class="span12 alert alert-danger">
            <h2>Delete this upload forever?</h2>
            <button id="no_delete" class="btn btn-primary">Keep</button>
            <form method="post"
                  action="{% url 'api_dispatch_remove_archive' resource_name='Archive' api_name='v1' pk=archive.pk %}"
                  style="margin: 0 0 0 100px; display: inline">
                <button type="submit" class="btn">Delete Forever</button>
            </form>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <h1 id="archive-identifier" data-value="{{ archive.identifier }}">{{ archive.identifier }}</h1>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span9">
            <h3 id="archive-site" data-value="{{ archive.site }}">{{ archive.site }}</h3>
        </div>
        <div class="span3">
            <h3 id="archive-type" style="text-align: right"
                data-value="{{ archive.archive_type }}">{{ archive.get_archive_type_display }}</h3>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span6">
            <span class="muted" id="archive-summary"
                  data-value="{{ archive.summary }}">{{ archive.summary | default:"No Summary" }}</span>
        </div>
        <div class="span3">
            {% if archive.taser_ticket_number %}
                <a id="archive-taser" href="https://jira.amer.thermo.com/browse/FST-{{ archive.taser_ticket_number }}"
                   target="_blank"
                   data-value="{{ archive.taser_ticket_number }}">TASER: {{ archive.taser_ticket_number }}</a>
            {% else %}
                <span id="archive-taser" class="muted" data-value="">No TASER Ticket</span>
            {% endif %}
        </div>
        <div class="span3">
            <p style="float: right;"><em>{{ archive.time }}, uploaded by {{ archive.submitter_name }}</em></p>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div class="form-actions">
                <div class="pull-left">
                    <a class="btn btn-success" href="/media/{{ archive.doc_file }}"><i
                            class="icon-arrow-down icon-white"></i> Download Archive</a>
                    <a class="btn" href="/media/archive_files/{{ archive.pk }}/"><i class="icon-folder-open"></i> View
                        Files</a>
                    <a class="btn" id="archive-edit"><i class="icon-edit"></i> Edit</a>
                    <form method="POST"
                          action="{% url 'api_dispatch_rerun_archive' resource_name='Archive' api_name='v1' pk=archive.pk %}"
                          style="margin: 0; display: inline">
                        <button type="submit" class="btn"><i class="icon-repeat"></i> Re-run Tests</button>
                    </form>
                </div>
                <div class="pull-right">
                    <button id="ask_delete" class="btn btn-danger"><i class="icon-trash icon-white"></i> Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12">
            <table id="test-summary" class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>Test</th>
                    <th>Status</th>
                    <th>Details</th>
                    <th>Run At</th>
                    <th>Results</th>
                    <th>Readme</th>
                </tr>
                </thead>
                <tbody>
                {% for test in archive.diagnostics.all %}
                    <tr>
                        <td>{{ test.display_name }}</td>
                        <td>
                            {% if test.status == 'Unexecuted' %}
                                <span class="label">{{ test.status }}</span>
                            {% elif test.status == 'Executing' %}
                                <span class="label">{{ test.status }}</span>
                            {% elif test.status == 'Alert' %}
                                <span class="label label-important">{{ test.status }}</span>
                            {% elif test.status == 'Info' %}
                                <span class="label label-info">{{ test.status }}</span>
                            {% elif test.status == 'Warning' %}
                                <span class="label label-warning">{{ test.status }}</span>
                            {% elif test.status == 'OK' %}
                                <span class="label label-success">{{ test.status }}</span>
                            {% elif test.status == 'NA' %}
                                <span class="label">{{ test.status }}</span>
                            {% elif test.status == 'Failed' %}
                                <span class="label" style="background-color: darkred">{{ test.status }}</span>
                            {% else %}
                                <span class="label">{{ test.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ test.details|safe }}
                        </td>
                        <td>
                            {{ test.start_execute }}
                        </td>
                        <td>
                            {% if test.html %}
                                <a href="/media/archive_files/{{ archive.id }}/test_results/{{ test.name }}/{{ test.html }}">Results</a>
                            {% endif %}
                        </td>
                        <td>
                            {% if test.readme %}
                                <a href="/diagnostic/{{ test.name }}">Readme</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if pdf_present %}
        <div class="row-fluid" style="margin-top: 20px;">
            <div id="run_report" class="span12">
                <div id="pdf">
                    <object type="application/pdf" data="/media/archive_files/{{ archive.id }}/report.pdf"
                            height="600px" width="100%">
                        <p>Your browser does not support PDF display</p>
                    </object>
                </div>
                <a href="/media/archive_files/{{ archive.id }}/report.pdf" class="btn btn-success">
                    <i class="icon-arrow-down icon-white"></i> Download Report
                </a>
            </div>
        </div>
    {% else %}
        <div class="row-fluid" style="">
            <div id="no_report" class="span12 text-center" style="display:none;">
                <small>There is no report.pdf for this archive.</small>
            </div>
        </div>
    {% endif %}
    <script>
        //Archive editor
        var reportEditorApp = {
            archiveId: '{{ archive.pk }}',
            archiveTypes: JSON.parse('{{ archive_type_choices_json|safe }}'),
            elements: {
                editButton: $("#archive-edit"),
                archiveIdentifier: $("#archive-identifier"),
                archiveSite: $("#archive-site"),
                archiveType: $("#archive-type"),
                archiveSummary: $("#archive-summary"),
                archiveTaser: $("#archive-taser")
            },
            init: function () {
                this.elements.editButton.click(this.enable.bind(this));
            },
            enable: function () {
                // Switch button to save button
                this.elements.editButton.html("<i class='icon-ok icon-white'></i> Save");
                this.elements.editButton.addClass("btn-primary");
                this.elements.editButton.off('click');
                this.elements.editButton.click(this.save.bind(this));

                // Switch text to inputs
                [{
                    element: this.elements.archiveIdentifier,
                    fontSize: 25,
                    type: "text"
                }, {
                    element: this.elements.archiveSite,
                    fontSize: 25,
                    type: "text"
                }, {
                    element: this.elements.archiveSummary,
                    fontSize: 14,
                    type: "text"
                }, {
                    element: this.elements.archiveTaser,
                    fontSize: 14,
                    type: "number"
                }].map(function (item) {
                    var value = item.element.text();
                    item.element.html("").append($("<input/>", {
                        type: item.type,
                        value: item.element.data("value"),
                        style: "font-size:" + item.fontSize + "px;" +
                        "height: auto;" +
                        "vertical-align: top;" +
                        "margin-bottom: 0px;" +
                        "box-sizing: border-box;" +
                        "width: 100%;"
                    }))
                }.bind(this));

                //Switch text to inputs

                var archiveTypeSelect = $("<select/>", {
                    type: "text",
                    dir: "rtl",
                    style: "font-size: 25px;" +
                    "height: auto;" +
                    "vertical-align: top;" +
                    "margin-bottom: 0px;" +
                    "height: 40px;" +
                    "border-radius: 4px;" +
                    "box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);" +
                    "box-sizing: border-box;" +
                    "width: 100%;"
                });
                this.archiveTypes.map(function (type) {
                    archiveTypeSelect.append($("<option/>", {
                        text: type.name,
                        value: type.value,
                        selected: this.elements.archiveType.data("value") == type.value
                    }));
                }.bind(this));
                this.elements.archiveType.html("").append(archiveTypeSelect);

            },
            save: function () {
                $.ajax({
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    url: '/api/v1/Archive/' + this.archiveId + '/',
                    type: 'PATCH',
                    data: JSON.stringify({
                        identifier: this.elements.archiveIdentifier.find("input").val(),
                        site: this.elements.archiveSite.find("input").val(),
                        archive_type: this.elements.archiveType.find("select").val(),
                        summary: this.elements.archiveSummary.find("input").val(),
                        taser_ticket_number: this.elements.archiveTaser.find("input").val() || null
                    }),
                    success: function (response, textStatus, jqXhr) {
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("Error saving changes!");
                    },
                    complete: function () {
                        window.location = "";
                    }
                });
            }
        };
        reportEditorApp.init();
    </script>
{% endblock content %}